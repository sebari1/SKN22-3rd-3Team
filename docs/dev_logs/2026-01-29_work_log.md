# 2026-01-29일 업무 기록 (종합 보고서)

오늘의 주요 성과는 **RAG 성능 고도화를 위한 V3 파이프라인의 완전 재건축** 및 **도메인 특화 형태소 분석 환경 구축**입니다.

---

## 1. 도메인 사전 구축 및 형태소 분석 최적화
고양이 관련 전문 용어 및 품종명의 정확한 인식을 위해 도메인 사전을 구축하고 Kiwi 형태소 분석기를 고도화했습니다.

- **사전 구축 (Phase 1)**: `scripts/build_domain_dict.py`를 통해 약 1,153개의 가이드 및 품종 데이터에서 명사(NNP, NNG) 추출. (초기 약 3,340개 단어 후보군 확보)
- **사전 고도화 (Phase 2)**: `scripts/enrich_domain_dict.py` 프로젝트를 수행하여 V2 메타데이터의 핵심 키워드 및 엔티티를 사전에 병합.
- **LLM 기반 정제 (Phase 3)**: `scripts/refine_domain_dict.py` 환경 구축. `gpt-4o-mini`를 사용하여 노이즈가 섞인 단어를 필터링하고 고양이 도메인에 유효한 핵심 명사 **847개**로 최종 정제 완료.
- **분석기 연동**: `src/utils/text.py`에서 정제된 사전을 Kiwi에 로드하는 싱글톤 엔진을 구현하고, 불용어(Stopwords)를 정의하여 하이브리드 검색용 토큰 생성 품질을 강화.

## 2. V3 데이터 파이프라인 (Pure Clean Flow) 설계

### 전략 수립 및 아키텍처
- **전략 수립**: [v3_pipeline_strategy_report.md](file:///Users/leemdo/Workspaces/SKN22-3rd-3Team/docs/04_data/v3_pipeline_strategy_report.md) 및 [v3_pipeline_flow.md](file:///Users/leemdo/Workspaces/SKN22-3rd-3Team/docs/04_data/v3_pipeline_flow.md) 작성.
- **RAG Audit**: 검색 시 본문의 노이즈가 벡터 유사도를 저해하는 문제를 해결하기 위해 **"메타데이터 기반 구조적 임베딩(Structured Embedding)"** 정책 수립.
    - 임베딩 대상: `[카테고리] [전문가] 제목 | 키워드 | 요약`
    - 보존 영역: RAG 답변용 클리닝 본문(`text`) 및 형태소 분석 토큰(`tokenized_text`).

### 기술 스택 구현
- **스키마 표준화**: `src/pipelines/[v1,v2,v3]/schemas.py`의 전면 리팩토링.
    - LLM 응답용(`ExtractionArticleV3`)과 DB 저장용(`StoredDocumentV3`) 스키마를 상속 관계로 명확히 분리.
- **V3 Classifier**: `gpt-4o-mini`를 통한 제목 정제 및 의도 태그(`intent_tags`) 추출 로직 구현.
- **V3 Preprocessor**: 비동기 배치 처리를 지원하며, 원본 데이터의 `text` 필드를 정확히 매핑하도록 수정.
- **임베딩 병렬화 (Parallelization)**:
    - [embedding_parallel_plan.md](file:///Users/leemdo/.gemini/antigravity/brain/c3c8e87e-8dd5-416e-98be-cd447d4aaf3e/embedding_parallel_plan.md) 수립 및 구현.
    - `asyncio` 배치(100개 단위) 및 세마포어(5)를 적용하여 처리 속도를 약 40배 향상(약 13분 -> 15초 내외).
- **파이프라인 실행 완료**: 총 **1,138개**의 아티클에 대해 전처리(Classifier), 병렬 임베딩(Embedder), DB 적재(Loader) 과정을 모두 성공적으로 완료.

## 3. 데이터 인프라 운영 및 조치 사항

### 인프라 및 설정
- **DB 최적화**: V3 전용 데이터베이스 `cat_library` 및 `care_guides` 컬렉션 설정 완료.
- **검증 환경**: 몽고DB 적재 여부와 Pydantic 호환성을 즉각 확인하는 `scripts/verify_v3_data.py` 제작.
- **비용 분석**: 전체 1,153개 아티클 가공 비용 약 $0.40(한화 약 600원) 수준으로 경제성 검증.

### 장애 대응 (Incident Response)
- **데이터 삭제 사고 및 복구**: V3 작업 중 실수로 V1, V2 가공 데이터를 일괄 삭제했으나, Git `head` 체크아웃을 통해 손실 없이 100% 복구 완료.
- **환경 변수 이슈**: 스크립트 실행 시 `.env` 로딩 누락으로 인한 API 호출 실패 건을 `load_dotenv()` 강제 적용으로 해결.

## 4. 에이전트 및 기능 확장 설계
- **프롬프트 관리 시스템 (Prompt Management System)**:
    - **중앙화**: [prompts.yaml](file:///Users/leemdo/Workspaces/SKN22-3rd-3Team/src/core/prompts.yaml)에 모든 에이전트(`head_butler`, `physician`, `matchmaker` 등)의 시스템 프롬프트 및 페르소나를 집결.
    - **동적 로딩**: `src/core/prompt_manager.py` 싱글톤 엔진을 통해 서비스 재시작 없이 프롬프트 실시간 반영 구현.
    - **편집 인터페이스**: Streamlit 내 **'Prompt Editor'** 전용 페이지 구축. 운영 중 즉시 페르소나 수정 및 저장이 가능하도록 인터페이스화.
- **인증/온보딩**: 사용자 및 반려묘 프로필 관리를 위한 [auth_profile_spec.md](file:///Users/leemdo/Workspaces/SKN22-3rd-3Team/docs/05_feature/auth_profile_spec.md) 정의.
- **고양이 카드**: 검색 결과 내 시각적 컴포넌트인 [cat_card_spec.md](file:///Users/leemdo/Workspaces/SKN22-3rd-3Team/docs/05_feature/cat_card_spec.md) 설계.
- **개발자 도구 (DX)**: 
    - `agent_prompt_experiment.ipynb`를 고도화하여 LangGraph 전체 라우팅 경로를 실시간 트레이싱하고 결과물을 즉시 시각화하는 디버깅 환경 구축.

## 5. RAG 검색 및 에이전트 라우팅 정상화 (긴급 디버깅)

### 문제 상황
- **증상**: 에이전트가 `Physician` 노드로 라우팅되었으나, 검색 결과가 0건(`[]`)으로 반환됨.
- **원인 1 (인덱스 부재)**: V3 클러스터(`cat_library`)에 Atlas Search Index(`vector_index`, `keyword_index`)가 생성되지 않음.
- **원인 2 (스키마 불일치)**: 코드(`title`, `content`)와 V3 데이터(`title_refined`, `text`) 간 필드명 불일치.
- **원인 3 (라우팅 불안정)**: `AgentState`에 `care_sub_specialist` 등 하위 상태 필드 누락으로 인한 그래프 업데이트 무시.

### 조치 내역
1.  **Atlas Search 인덱스 생성**:
    - `vector_index` (Cosine, dimensions: 1536) 및 `keyword_index` (Dynamic Mapping) 설정 가이드 작성 및 적용.
2.  **코드 리팩토링**:
    - `src/agents/care_team.py` 및 `adoption_team.py`: V3 필드(`title_refined`)를 우선 참조하도록 수정.
    - `src/agents/state.py`: `AgentState` 스키마 확장.
    - **Hard Routing 적용**: Supervisor 노드에서 조건부 엣지 대신 명시적 `Command(goto="...")` 반환 방식으로 변경하여 안정성 확보.
3.  **검증**:
    - "고양이가 밥을 안 먹고 노란 토를 함" 질의에 대해 **10건의 문서** 검색 성공.
    - "No Title" 오류 해결 및 LLM이 검색된 문서를 바탕으로 답변 생성 확인.

---
**오늘의 결론**: 고양이 도메인 전문 사전 구축부터 V3 데이터 파이프라인의 완전 자동화, 그리고 운영 중에도 에이전트 지능(Prompt)을 즉시 튜닝할 수 있는 운영 인프라까지 확보하며 **RAG 서비스의 핵심 엔진 개발을 성공적으로 마무리**했습니다.
